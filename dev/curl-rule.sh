#!/bin/bash
################################################################################
# ç½‘ç»œè§„åˆ™ä¸‹è½½è„šæœ¬
# åŠŸèƒ½ï¼šä»å¤šä¸ª URL ä¸‹è½½ç½‘ç»œè§„åˆ™æ–‡ä»¶åˆ° tmp ç›®å½•
# ä½¿ç”¨æ–¹æ³•ï¼š./curl-rule.sh
# ç‰¹ç‚¹ï¼šå¤±è´¥æ—¶è®°å½•é”™è¯¯ä½†ä¸é€€å‡ºï¼Œæœ€åç»Ÿä¸€æŠ¥å‘Šæ‰€æœ‰é”™è¯¯
################################################################################

# æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
echo "=========================================="
echo "ğŸŒ å¼€å§‹ä¸‹è½½è§„åˆ™é›†"
echo "â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

################################################################################
# é…ç½®å‚æ•°åŒºåŸŸ
################################################################################

# æœ€å¤§é‡è¯•æ¬¡æ•°
MAX_RETRIES=3

# è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
TIMEOUT=15

# é‡è¯•é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
RETRY_DELAY=3

# ä¸´æ—¶ç›®å½•åç§°
TEMP_DIR="tmp"

################################################################################
# åˆå§‹åŒ–å˜é‡
################################################################################

# æˆåŠŸè®¡æ•°å™¨
success_count=0

# å¤±è´¥è®¡æ•°å™¨
failed_count=0

# é”™è¯¯ä¿¡æ¯æ•°ç»„ï¼ˆç”¨äºå­˜å‚¨æ‰€æœ‰å¤±è´¥çš„è¯¦æƒ…ï¼‰
error_messages=()

################################################################################
# å‡½æ•°å®šä¹‰åŒºåŸŸ
################################################################################

# å‡½æ•°ï¼šä¸‹è½½å•ä¸ªæ–‡ä»¶
# å‚æ•°ï¼š$1=URL, $2=è¾“å‡ºæ–‡ä»¶è·¯å¾„, $3=æè¿°åç§°, $4=å½“å‰åºå·, $5=æ€»æ•°
# è¿”å›ï¼š0=æˆåŠŸ, 1=å¤±è´¥
download_file() {
    local url="$1"
    local output_file="$2"
    local description="$3"
    local current_num="$4"
    local total_num="$5"

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â¬‡ï¸  æ­£åœ¨ä¸‹è½½ [$current_num/$total_num]: $description"
    echo "ğŸ“¥ URL: $url"
    echo "ğŸ’¾ ä¿å­˜åˆ°: $output_file"
    echo ""

    # é‡è¯•å¾ªç¯
    for ((retry=1; retry<=MAX_RETRIES; retry++)); do
        echo "ğŸ”„ å°è¯•ç¬¬ $retry æ¬¡ä¸‹è½½..."

        # æ‰§è¡Œä¸‹è½½å‘½ä»¤
        if curl -fsSL --connect-timeout "$TIMEOUT" "$url" -o "$output_file" 2>/dev/null; then
            # ä¸‹è½½æˆåŠŸ
            echo "âœ… ä¸‹è½½æˆåŠŸ: $description"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            return 0
        else
            # ä¸‹è½½å¤±è´¥
            echo "âŒ ä¸‹è½½å¤±è´¥ (ç¬¬ $retry æ¬¡å°è¯•)"

            # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡é‡è¯•ï¼Œåˆ™ç­‰å¾…åç»§ç»­
            if [ $retry -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’åé‡è¯•..."
                sleep $RETRY_DELAY
            fi
        fi
    done

    # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
    local error_msg="âŒ ä¸‹è½½å¤±è´¥: $description | URL: $url | æ–‡ä»¶: $output_file | å·²é‡è¯• $MAX_RETRIES æ¬¡"
    error_messages+=("$error_msg")
    echo ""
    echo "âš ï¸  æœ€ç»ˆä¸‹è½½å¤±è´¥: $description"
    echo "ğŸ’¡ åŸå› : ç½‘ç»œè¿æ¥è¶…æ—¶æˆ–æœåŠ¡å™¨æ— å“åº” (å·²é‡è¯• $MAX_RETRIES æ¬¡)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    return 1
}

# å‡½æ•°ï¼šåˆ›å»ºä¸´æ—¶ç›®å½•
# è¿”å›ï¼š0=æˆåŠŸ, 1=å¤±è´¥
create_temp_dir() {
    echo "ğŸ“ åˆ›å»ºä¸´æ—¶ç›®å½•: $TEMP_DIR"

    if mkdir -p "$TEMP_DIR" 2>/dev/null; then
        echo "âœ… ä¸´æ—¶ç›®å½•åˆ›å»ºæˆåŠŸ"
        echo ""
        return 0
    else
        local error_msg="âŒ æ— æ³•åˆ›å»ºä¸´æ—¶ç›®å½•: $TEMP_DIR | è¯·æ£€æŸ¥ç›®å½•æƒé™"
        error_messages+=("$error_msg")
        echo "âš ï¸  ä¸´æ—¶ç›®å½•åˆ›å»ºå¤±è´¥"
        echo "ğŸ’¡ åŸå› : å¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–ç£ç›˜ç©ºé—´ä¸è¶³"
        echo ""
        return 1
    fi
}

################################################################################
# ä¸»ç¨‹åºå¼€å§‹
################################################################################

# åˆ›å»ºä¸´æ—¶ç›®å½•
create_temp_dir

# å®šä¹‰ä¸‹è½½åˆ—è¡¨
# æ ¼å¼ï¼šURL|è¾“å‡ºæ–‡ä»¶è·¯å¾„|æè¿°åç§°
downloads=(
    "https://ruleset.skk.moe/Clash/ip/china_ip.txt|tmp/cnipv4.txt|ä¸­å›½IPv4åœ°å€è§„åˆ™"
    "https://ruleset.skk.moe/Clash/ip/china_ip_ipv6.txt|tmp/cnipv6.txt|ä¸­å›½IPv6åœ°å€è§„åˆ™"
    "https://core.telegram.org/resources/cidr.txt|tmp/tgip.txt|Telegram IPåœ°å€è§„åˆ™"
    "https://ruleset.skk.moe/Clash/domainset/cdn.txt|tmp/cdn_domain.txt|CDNåŸŸåè§„åˆ™"
    "https://ruleset.skk.moe/Clash/non_ip/cdn.txt|tmp/cdn_classical.txt|CDNç»å…¸è§„åˆ™"
    "https://ruleset.skk.moe/Clash/non_ip/global.txt|tmp/global.txt|å…¨å±€è§„åˆ™"
    "https://ruleset.skk.moe/Clash/non_ip/domestic.txt|tmp/domestic.txt|å›½å†…è§„åˆ™"
    "https://ruleset.skk.moe/Clash/non_ip/lan.txt|tmp/lan_classical.txt|å±€åŸŸç½‘ç»å…¸è§„åˆ™"
    "https://ruleset.skk.moe/Clash/ip/lan.txt|tmp/lan_ip.txt|å±€åŸŸç½‘IPè§„åˆ™"
)

# è·å–ä¸‹è½½ä»»åŠ¡æ€»æ•°
total_downloads=${#downloads[@]}

# å¼€å§‹éå†ä¸‹è½½åˆ—è¡¨
for i in "${!downloads[@]}"; do
    # è§£æä¸‹è½½é¡¹ï¼ˆä½¿ç”¨ | åˆ†éš”ç¬¦ï¼‰
    IFS='|' read -r url file desc <<< "${downloads[$i]}"

    # è°ƒç”¨ä¸‹è½½å‡½æ•°ï¼ˆåºå·ä»1å¼€å§‹ï¼‰
    current_num=$((i + 1))
    if download_file "$url" "$file" "$desc" "$current_num" "$total_downloads"; then
        # ä¸‹è½½æˆåŠŸï¼Œè®¡æ•°å™¨åŠ 1
        ((success_count++))
    else
        # ä¸‹è½½å¤±è´¥ï¼Œè®¡æ•°å™¨åŠ 1
        ((failed_count++))
    fi
done

################################################################################
# è¾“å‡ºæœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
################################################################################

echo ""
echo "=========================================="
echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡æŠ¥å‘Š"
echo "=========================================="
echo "ğŸ“¦ æ€»ä»»åŠ¡æ•°: $total_downloads"
echo "âœ… æˆåŠŸæ•°: $success_count"
echo "âŒ å¤±è´¥æ•°: $failed_count"
echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

# å¦‚æœæœ‰å¤±è´¥çš„ä¸‹è½½ä»»åŠ¡ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
if [ $failed_count -gt 0 ]; then
    echo "âš ï¸  ä»¥ä¸‹æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼š"
    echo ""
    for error_msg in "${error_messages[@]}"; do
        echo "  $error_msg"
    done
    echo ""
    echo "ğŸ’¡ å»ºè®®ï¼š"
    echo "  1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
    echo "  2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®"
    echo "  3. ç¨åé‡æ–°è¿è¡Œæ­¤è„šæœ¬"
    echo "  4. æ£€æŸ¥æºæœåŠ¡å™¨æ˜¯å¦å¯ç”¨"
    echo ""
fi

# æ˜¾ç¤ºåç»­æ“ä½œæç¤º
echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
if [ $failed_count -eq 0 ]; then
    echo "  âœ… æ‰€æœ‰æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¯ä»¥è¿è¡Œ ./process-rule.sh å¤„ç†è§„åˆ™"
else
    echo "  âš ï¸  éƒ¨åˆ†æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œåé‡æ–°è¿è¡Œæ­¤è„šæœ¬"
    echo "  â„¹ï¸  å·²ä¸‹è½½çš„æ–‡ä»¶å¯ä»¥ç»§ç»­ä½¿ç”¨ ./process-rule.sh å¤„ç†"
fi
echo ""

# è„šæœ¬æ­£å¸¸é€€å‡ºï¼ˆå³ä½¿æœ‰å¤±è´¥ä¹Ÿä¸ä½¿ç”¨ exit 1ï¼‰
exit 0
