#!/bin/bash
################################################################################
# è§„åˆ™å¤„ç†è„šæœ¬
# åŠŸèƒ½ï¼šå¤„ç†ä¸‹è½½çš„è§„åˆ™æ–‡ä»¶ï¼Œåˆå¹¶ã€å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•
# ä½¿ç”¨æ–¹æ³•ï¼š./process-rule.sh
# ç‰¹ç‚¹ï¼šå¤±è´¥æ—¶è®°å½•é”™è¯¯ä½†ä¸é€€å‡ºï¼Œæœ€åç»Ÿä¸€æŠ¥å‘Šæ‰€æœ‰é”™è¯¯
################################################################################

# æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
echo "=========================================="
echo "ğŸ”„ å¼€å§‹å¤„ç†è§„åˆ™æ–‡ä»¶"
echo "â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

################################################################################
# é…ç½®å‚æ•°åŒºåŸŸ
################################################################################

# è¾“å…¥ç›®å½•ï¼ˆä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼‰
INPUT_DIR="tmp"

# è¾“å‡ºç›®å½•ï¼ˆè§„åˆ™æ–‡ä»¶ç›®å½•ï¼‰
OUTPUT_DIR="bot-mihomo"

# è¾“å‡ºå­ç›®å½•
DOMAIN_DIR="$OUTPUT_DIR/domain"
CLASSICAL_DIR="$OUTPUT_DIR/classical"
IP_DIR="$OUTPUT_DIR/ip"

################################################################################
# åˆå§‹åŒ–å˜é‡
################################################################################

# æˆåŠŸè®¡æ•°å™¨
success_count=0

# å¤±è´¥è®¡æ•°å™¨
failed_count=0

# è·³è¿‡è®¡æ•°å™¨
skipped_count=0

# é”™è¯¯ä¿¡æ¯æ•°ç»„
error_messages=()

################################################################################
# å‡½æ•°å®šä¹‰åŒºåŸŸ
################################################################################

# å‡½æ•°ï¼šæ£€æŸ¥è¾“å…¥ç›®å½•æ˜¯å¦å­˜åœ¨
# è¿”å›ï¼š0=å­˜åœ¨, 1=ä¸å­˜åœ¨
check_input_directory() {
    echo "ğŸ” æ£€æŸ¥è¾“å…¥ç›®å½•..."
    echo "   ç›®å½•è·¯å¾„: $INPUT_DIR"
    echo ""

    if [ -d "$INPUT_DIR" ]; then
        echo "âœ… è¾“å…¥ç›®å½•å­˜åœ¨"

        # æ˜¾ç¤ºç›®å½•ä¸­çš„æ–‡ä»¶
        local file_count=$(ls -1 "$INPUT_DIR" 2>/dev/null | wc -l)
        echo "   æ–‡ä»¶æ•°é‡: $file_count"
        echo ""
        return 0
    else
        local error_msg="âŒ è¾“å…¥ç›®å½•ä¸å­˜åœ¨ | ç›®å½•: $INPUT_DIR | è¯·å…ˆè¿è¡Œ ./curl-rule.sh ä¸‹è½½è§„åˆ™æ–‡ä»¶"
        error_messages+=("$error_msg")
        echo "âš ï¸  è¾“å…¥ç›®å½•ä¸å­˜åœ¨: $INPUT_DIR"
        echo "ğŸ’¡ è¯·å…ˆè¿è¡Œ ./curl-rule.sh ä¸‹è½½è§„åˆ™æ–‡ä»¶"
        echo ""
        return 1
    fi
}

# å‡½æ•°ï¼šåˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
# è¿”å›ï¼š0=æˆåŠŸ, 1=å¤±è´¥
create_output_directories() {
    echo "ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„..."
    echo ""

    # åˆ›å»ºä¸»è¾“å‡ºç›®å½•
    if mkdir -p "$OUTPUT_DIR" 2>/dev/null; then
        echo "âœ… ä¸»è¾“å‡ºç›®å½•åˆ›å»ºæˆåŠŸ: $OUTPUT_DIR"
    else
        local error_msg="âŒ åˆ›å»ºä¸»è¾“å‡ºç›®å½•å¤±è´¥ | ç›®å½•: $OUTPUT_DIR | è¯·æ£€æŸ¥æƒé™"
        error_messages+=("$error_msg")
        echo "âš ï¸  åˆ›å»ºä¸»è¾“å‡ºç›®å½•å¤±è´¥: $OUTPUT_DIR"
        echo ""
        return 1
    fi

    # åˆ›å»ºåŸŸåè§„åˆ™ç›®å½•
    if mkdir -p "$DOMAIN_DIR" 2>/dev/null; then
        echo "âœ… åŸŸåè§„åˆ™ç›®å½•åˆ›å»ºæˆåŠŸ: $DOMAIN_DIR"
    else
        local error_msg="âŒ åˆ›å»ºåŸŸåè§„åˆ™ç›®å½•å¤±è´¥ | ç›®å½•: $DOMAIN_DIR"
        error_messages+=("$error_msg")
        echo "âš ï¸  åˆ›å»ºåŸŸåè§„åˆ™ç›®å½•å¤±è´¥: $DOMAIN_DIR"
    fi

    # åˆ›å»ºç»å…¸è§„åˆ™ç›®å½•
    if mkdir -p "$CLASSICAL_DIR" 2>/dev/null; then
        echo "âœ… ç»å…¸è§„åˆ™ç›®å½•åˆ›å»ºæˆåŠŸ: $CLASSICAL_DIR"
    else
        local error_msg="âŒ åˆ›å»ºç»å…¸è§„åˆ™ç›®å½•å¤±è´¥ | ç›®å½•: $CLASSICAL_DIR"
        error_messages+=("$error_msg")
        echo "âš ï¸  åˆ›å»ºç»å…¸è§„åˆ™ç›®å½•å¤±è´¥: $CLASSICAL_DIR"
    fi

    # åˆ›å»º IP è§„åˆ™ç›®å½•
    if mkdir -p "$IP_DIR" 2>/dev/null; then
        echo "âœ… IP è§„åˆ™ç›®å½•åˆ›å»ºæˆåŠŸ: $IP_DIR"
    else
        local error_msg="âŒ åˆ›å»º IP è§„åˆ™ç›®å½•å¤±è´¥ | ç›®å½•: $IP_DIR"
        error_messages+=("$error_msg")
        echo "âš ï¸  åˆ›å»º IP è§„åˆ™ç›®å½•å¤±è´¥: $IP_DIR"
    fi

    echo ""
    return 0
}

# å‡½æ•°ï¼šå¤åˆ¶å•ä¸ªæ–‡ä»¶
# å‚æ•°ï¼š$1=æºæ–‡ä»¶, $2=ç›®æ ‡æ–‡ä»¶, $3=æè¿°åç§°
# è¿”å›ï¼š0=æˆåŠŸ, 1=å¤±è´¥, 2=è·³è¿‡ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰
copy_file() {
    local src_file="$1"
    local dst_file="$2"
    local description="$3"

    # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$src_file" ]; then
        local error_msg="âš ï¸  æºæ–‡ä»¶ä¸å­˜åœ¨ | æ–‡ä»¶: $src_file | æè¿°: $description"
        error_messages+=("$error_msg")
        echo "âš ï¸  è·³è¿‡: $description (æºæ–‡ä»¶ä¸å­˜åœ¨: $src_file)"
        ((skipped_count++))
        return 2
    fi

    # æ‰§è¡Œå¤åˆ¶æ“ä½œ
    if cp "$src_file" "$dst_file" 2>/dev/null; then
        echo "âœ… æˆåŠŸ: $description"
        echo "   æºæ–‡ä»¶: $src_file"
        echo "   ç›®æ ‡æ–‡ä»¶: $dst_file"
        ((success_count++))
        return 0
    else
        local error_msg="âŒ å¤åˆ¶æ–‡ä»¶å¤±è´¥ | æº: $src_file | ç›®æ ‡: $dst_file | æè¿°: $description"
        error_messages+=("$error_msg")
        echo "âŒ å¤±è´¥: $description"
        echo "   æºæ–‡ä»¶: $src_file"
        echo "   ç›®æ ‡æ–‡ä»¶: $dst_file"
        ((failed_count++))
        return 1
    fi
}

# å‡½æ•°ï¼šåˆå¹¶å¤šä¸ªæ–‡ä»¶
# å‚æ•°ï¼š$1=æºæ–‡ä»¶åˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰, $2=ç›®æ ‡æ–‡ä»¶, $3=æè¿°åç§°
# è¿”å›ï¼š0=æˆåŠŸ, 1=å¤±è´¥, 2=è·³è¿‡ï¼ˆæ–‡ä»¶ç¼ºå¤±ï¼‰
merge_files() {
    local src_files="$1"
    local dst_file="$2"
    local description="$3"

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”— åˆå¹¶æ–‡ä»¶: $description"
    echo "   ç›®æ ‡æ–‡ä»¶: $dst_file"
    echo ""

    # æ£€æŸ¥æ‰€æœ‰æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    local missing_files=()
    for src_file in $src_files; do
        if [ ! -f "$src_file" ]; then
            missing_files+=("$src_file")
        fi
    done

    # å¦‚æœæœ‰ç¼ºå¤±çš„æ–‡ä»¶
    if [ ${#missing_files[@]} -gt 0 ]; then
        local error_msg="âš ï¸  åˆå¹¶å¤±è´¥: $description | ç¼ºå¤±æ–‡ä»¶: ${missing_files[*]}"
        error_messages+=("$error_msg")
        echo "âš ï¸  è·³è¿‡: $description"
        echo "ğŸ’¡ ç¼ºå¤±çš„æ–‡ä»¶:"
        for missing_file in "${missing_files[@]}"; do
            echo "   - $missing_file"
        done
        ((skipped_count++))
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        return 2
    fi

    # æ˜¾ç¤ºè¦åˆå¹¶çš„æ–‡ä»¶åˆ—è¡¨
    echo "ğŸ“„ è¦åˆå¹¶çš„æ–‡ä»¶:"
    for src_file in $src_files; do
        local file_size=$(wc -c < "$src_file" 2>/dev/null)
        echo "   - $src_file ($file_size å­—èŠ‚)"
    done
    echo ""

    # æ‰§è¡Œåˆå¹¶æ“ä½œ
    if cat $src_files > "$dst_file" 2>/dev/null; then
        local total_size=$(wc -c < "$dst_file" 2>/dev/null)
        echo "âœ… åˆå¹¶æˆåŠŸ: $description"
        echo "   æ€»å¤§å°: $total_size å­—èŠ‚"
        ((success_count++))
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        return 0
    else
        local error_msg="âŒ åˆå¹¶æ–‡ä»¶å¤±è´¥ | ç›®æ ‡: $dst_file | æè¿°: $description"
        error_messages+=("$error_msg")
        echo "âŒ åˆå¹¶å¤±è´¥: $description"
        ((failed_count++))
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        return 1
    fi
}

################################################################################
# ä¸»ç¨‹åºå¼€å§‹
################################################################################

# æ­¥éª¤ 1: æ£€æŸ¥è¾“å…¥ç›®å½•
check_input_directory

# æ­¥éª¤ 2: åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
create_output_directories

# æ­¥éª¤ 3: å¤„ç†ä¸­å›½ IP è§„åˆ™ï¼ˆåˆå¹¶ IPv4 å’Œ IPv6ï¼‰
merge_files "tmp/cnipv4.txt tmp/cnipv6.txt" "bot-mihomo/ip/cn.txt" "ä¸­å›½ IP è§„åˆ™"

# æ­¥éª¤ 4: å¤„ç† Telegram IP è§„åˆ™
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
copy_file "tmp/tgip.txt" "bot-mihomo/ip/tgip.txt" "Telegram IP è§„åˆ™"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ­¥éª¤ 5: å¤„ç† CDN åŸŸåè§„åˆ™
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
copy_file "tmp/cdn_domain.txt" "bot-mihomo/domain/cdn.txt" "CDN åŸŸåè§„åˆ™"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ­¥éª¤ 6: å¤„ç† CDN ç»å…¸è§„åˆ™
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
copy_file "tmp/cdn_classical.txt" "bot-mihomo/classical/cdn.txt" "CDN ç»å…¸è§„åˆ™"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ­¥éª¤ 7: å¤„ç†å…¨å±€è§„åˆ™
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
copy_file "tmp/global.txt" "bot-mihomo/classical/global.txt" "å…¨å±€è§„åˆ™"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ­¥éª¤ 8: å¤„ç†å›½å†…è§„åˆ™
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
copy_file "tmp/domestic.txt" "bot-mihomo/classical/cn.txt" "å›½å†…è§„åˆ™"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ­¥éª¤ 9: å¤„ç†å±€åŸŸç½‘è§„åˆ™ï¼ˆåˆå¹¶ç»å…¸è§„åˆ™å’Œ IP è§„åˆ™ï¼‰
merge_files "tmp/lan_classical.txt tmp/lan_ip.txt" "bot-mihomo/classical/lan.txt" "å±€åŸŸç½‘è§„åˆ™"

################################################################################
# è¾“å‡ºæœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š
################################################################################

echo ""
echo "=========================================="
echo "ğŸ“Š å¤„ç†ç»Ÿè®¡æŠ¥å‘Š"
echo "=========================================="
echo "âœ… æˆåŠŸå¤„ç†: $success_count ä¸ªæ–‡ä»¶"
echo "âŒ å¤„ç†å¤±è´¥: $failed_count ä¸ªæ–‡ä»¶"
echo "âš ï¸  è·³è¿‡å¤„ç†: $skipped_count ä¸ªæ–‡ä»¶"
echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

# æ˜¾ç¤ºè¾“å‡ºç›®å½•ä¿¡æ¯
if [ -d "$OUTPUT_DIR" ]; then
    echo "ğŸ“ è¾“å‡ºç›®å½•ç»“æ„:"
    echo "   $OUTPUT_DIR/"
    echo "   â”œâ”€â”€ domain/     (åŸŸåè§„åˆ™)"
    echo "   â”œâ”€â”€ classical/  (ç»å…¸è§„åˆ™)"
    echo "   â””â”€â”€ ip/         (IP è§„åˆ™)"
    echo ""
fi

# å¦‚æœæœ‰é”™è¯¯æˆ–è·³è¿‡çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
if [ $failed_count -gt 0 ] || [ $skipped_count -gt 0 ]; then
    echo "âš ï¸  è¯¦ç»†ä¿¡æ¯ï¼š"
    echo ""

    # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if [ ${#error_messages[@]} -gt 0 ]; then
        for error_msg in "${error_messages[@]}"; do
            echo "  $error_msg"
        done
        echo ""
    fi

    echo "ğŸ’¡ å»ºè®®ï¼š"
    echo "  1. æ£€æŸ¥ tmp ç›®å½•ä¸­æ˜¯å¦æœ‰æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶"
    echo "  2. å¦‚æœ‰æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·é‡æ–°è¿è¡Œ ./curl-rule.sh ä¸‹è½½"
    echo "  3. æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³"
    echo "  4. æ£€æŸ¥æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®"
    echo ""
fi

# æ˜¾ç¤ºåç»­æ“ä½œæç¤º
echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
if [ $failed_count -eq 0 ] && [ $skipped_count -eq 0 ]; then
    echo "  âœ… æ‰€æœ‰è§„åˆ™æ–‡ä»¶å¤„ç†æˆåŠŸï¼Œå¯ä»¥è¿è¡Œ ./git-push.sh æäº¤æ›´æ”¹"
elif [ $failed_count -eq 0 ]; then
    echo "  âš ï¸  éƒ¨åˆ†æ–‡ä»¶è¢«è·³è¿‡ï¼Œä½†å·²å¤„ç†çš„æ–‡ä»¶å¯ä»¥æäº¤"
    echo "  â„¹ï¸  å¯ä»¥è¿è¡Œ ./git-push.sh æäº¤å·²å¤„ç†çš„æ–‡ä»¶"
else
    echo "  âš ï¸  æœ‰æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥é”™è¯¯ä¿¡æ¯åé‡è¯•"
    echo "  â„¹ï¸  å¯ä»¥è¿è¡Œ ./curl-rule.sh é‡æ–°ä¸‹è½½ç¼ºå¤±çš„æ–‡ä»¶"
fi
echo ""

# è„šæœ¬æ­£å¸¸é€€å‡ºï¼ˆå³ä½¿æœ‰å¤±è´¥ä¹Ÿä¸ä½¿ç”¨ exit 1ï¼‰
exit 0
